var FPF_Condition_Builder=function(){function e(e){this.wrapper=e,this.init()}var t=e.prototype;return t.init=function(){this.initEvents(),this.initLoadConditions()},t.initEvents=function(){document.addEventListener("click",function(e){this.addConditionEvent(e),this.deleteConditionEvent(e),this.deleteGroupConditionEvent(e)}.bind(this)),document.addEventListener("afterConditionSettings",function(e){this.loadConditionAssets(e.detail.condition_name,e.detail.element)}.bind(this)),document.addEventListener("onFPFSearchDropdownSingleValueChange",function(e){this.handleConditionSelector(e)}.bind(this)),document.addEventListener("onFPFSearchDropdownSingleValueRemove",function(e){this.onConditionReset(e)}.bind(this))},t.onConditionReset=function(e){var e=e.detail.element.closest(".fpf-conditionbuilder-item"),t=document.createElement("div"),e=(t.classList.add("select-condition-message"),t.innerHTML=fpf_js_object.FPF_CB_SELECT_CONDITION_GET_STARTED,e.querySelector(".fpf-conditionbuilder-item-content"));e.innerHTML="",e.appendChild(t)},t.initLoadConditions=function(){this.wrapper.classList.add("loading");var i,e=this.wrapper.previousElementSibling.value;e?(e={data:e,plugin:this.wrapper.dataset.plugin,name:this.wrapper.previousElementSibling.getAttribute("name"),exclude_rules_pro:"1"===this.wrapper.dataset.exclude_rules_pro,include_rules:this.wrapper.dataset.includeRules,exclude_rules:this.wrapper.dataset.excludeRules},(i=this).call("init_load",e,function(e){var t=i.wrapper.querySelector(".fpf-conditionbuilder-initial-message");t&&t.remove(),i.wrapper=i.wrapper.closest(".fpf-conditionbuilder-wrapper").querySelector(".fpf-conditionbuilder"),i.wrapper.querySelector(".fpf-conditionbuilder-groups").innerHTML=e,i.getValidRules().forEach(function(e){i.loadConditionAssets(e.value,e.closest(".fpf-conditionbuilder-item"))}),i.wrapper.classList.remove("loading"),i.wrapper.classList.add("init-load-done")})):this.wrapper.querySelector(".fpf-cb-add-new-group").click()},t.loadConditionAssets=function(e,t){var i=fpf_js_object.media_url;switch(e){case"Date\\Date":case"Date\\Time":FPF_Helper.loadStyleSheet(i+"public/css/flatpickr.min.css"),FPF_Helper.loadStyleSheet(i+"admin/css/fpf_datetimepicker.css"),FPF_Helper.loadScript(i+"public/js/flatpickr.min.js",function(){FPF_Helper.loadScript(i+"admin/js/fpf_datepicker.js",function(){},!0)});break;case"PHP":FPF_Helper.loadScript(i+"admin/js/fpf_textarea.js",function(){"function"==typeof FPF_Textarea&&new FPF_Textarea(t).init()});break;case"Geo\\City":case"Geo\\Region":case"URL":case"IP":case"Referrer":FPF_Helper.loadStyleSheet(i+"admin/css/fpf_repeater.css"),FPF_Helper.loadScript(i+"admin/js/sortable.min.js",function(){FPF_Helper.loadScript(i+"admin/js/fpf_repeater.js",function(){"function"==typeof FPF_Repeater&&FPF_Repeater.initDragManager()})})}},t.handleConditionSelector=function(e){var t,i,n;e.detail.container.classList.contains("fpf-conditions-field")&&(t=e.detail.key,(i=e.detail.element).classList.contains("prevent-click")||i.classList.contains("is-pro")?e.preventDefault():((n=i.closest(".fpf-conditionbuilder-item")).classList.add("fpf-cb-loading"),this.loadConditionSettings(n,t,function(){n.classList.remove("fpf-cb-loading")})))},t.loadConditionSettings=function(t,i,n){var e=parseInt(t.closest(".fpf-conditionbuilder-group").dataset.key),o=parseInt(t.closest(".fpf-conditionbuilder-item").dataset.key),e={plugin:this.wrapper.dataset.plugin,conditionItemGroup:this.wrapper.previousElementSibling.getAttribute("name")+"["+e+"][rules]["+o+"]",exclude_rules:this.wrapper.dataset.excludeRules,name:i};this.call("options",e,function(e){e=""!==e?e:'<div class="select-condition-message">'+fpf_js_object.FPF_CB_SELECT_CONDITION_GET_STARTED+"</div>",t.querySelector(".fpf-conditionbuilder-item-content").innerHTML=e;e=new CustomEvent("afterConditionSettings",{detail:{element:t,condition_name:i}});document.dispatchEvent(e),n&&n()})},t.deleteGroupConditionEvent=function(e){e.target.closest(".removeGroupCondition")&&(e.preventDefault(),e=e.target.closest(".fpf-conditionbuilder-group"),this.getValidRules(e).length&&!confirm(fpf_js_object.FPF_ARE_YOU_SURE_YOU_WANT_TO_DELETE_THIS_ITEM)||(1!=this.getTotalConditionGroups()?e.remove():(e.querySelectorAll(".fpf-conditionbuilder-item:not(:first-child)").forEach(function(e){e.remove()}),this.resetCondition(e.querySelector(".fpf-conditionbuilder-item")))))},t.deleteConditionEvent=function(e){var t=e.target.closest(".fpf-cb-remove-condition");t&&(e.preventDefault(),e=t.closest(".fpf-conditionbuilder-item"),this.getSelectedCondition(e)&&!confirm(fpf_js_object.FPF_ARE_YOU_SURE_YOU_WANT_TO_DELETE_THIS_ITEM)||(1==this.getTotalConditionItems()?this.resetCondition(e):this.deleteCondition(e)))},t.getSelectedCondition=function(e){e=e.querySelector(".fpf-conditions-field .fpf-selected-dropdown-value");if(e)return e.value},t.deleteCondition=function(e){var t=e.closest(".fpf-conditionbuilder-group");e.remove(),0==t.querySelectorAll(".fpf-conditionbuilder-item").length&&t.remove()},t.resetCondition=function(e){e.querySelector(".fpf-searchdropdown-remove-single-value-button").click();var t=document.createElement("div");t.classList.add("select-condition-message"),t.innerHTML=fpf_js_object.FPF_CB_SELECT_CONDITION_GET_STARTED,e.querySelector(".fpf-conditionbuilder-item-content").appendChild(t)},t.getTotalConditionGroups=function(){return this.wrapper.querySelectorAll(".fpf-conditionbuilder-group").length},t.getValidRules=function(e){var e=(e=void 0===e?this.wrapper:e).querySelectorAll(".fpf-conditions-field .fpf-selected-dropdown-value"),t=[];return e.forEach(function(e){""!==e.value&&t.push(e)}),t},t.getTotalConditionItems=function(){return this.wrapper.querySelectorAll(".fpf-conditionbuilder-item").length},t.addConditionEvent=function(e){var t,i,n=e.target.closest(".fpf-cb-add-new-group");n&&(e.preventDefault(),e=(t=n.closest(".fpf-conditionbuilder-item")||n).closest(".fpf-conditionbuilder-group"),n=groupKey=0,n=this.addingNewGroup(t)?(groupKey=this.findHighestGroupKey()+1,0):(groupKey=parseInt(e.dataset.key),this.findHighestGroupItemKey(e)+1),t.classList.add("fpf-cb-loading"),(i=this).addCondition(t,this.wrapper.previousElementSibling.getAttribute("name"),groupKey,n,function(){t.classList.remove("fpf-cb-loading"),i.wrapper.classList.remove("loading"),i.wrapper.classList.add("init-load-done")}))},t.findHighestGroupKey=function(){var e=this.wrapper.querySelectorAll(".fpf-conditionbuilder-group[data-key]");return 0===e.length?0:Math.max.apply(Math,Array.from(e).map(function(e){return parseInt(e.dataset.key)}))},t.findHighestGroupItemKey=function(e){return Math.max.apply(Math,Array.from(e.querySelectorAll(".fpf-conditionbuilder-item[data-key]")).map(function(e){return parseInt(e.dataset.key)}))},t.addCondition=function(i,e,t,n,o){var r=this.addingNewGroup(i),d={conditionItemGroup:e,groupKey:t,conditionKey:n,exclude_rules_pro:"1"===this.wrapper.dataset.exclude_rules_pro,include_rules:this.wrapper.dataset.includeRules,exclude_rules:this.wrapper.dataset.excludeRules,addingNewGroup:r},a=this;this.call("add",d,function(e){var t=document.createElement("div"),e=(t.innerHTML=e,a.wrapper.querySelector(".fpf-conditionbuilder-initial-message"));e&&e.remove(),r?(a.wrapper.querySelector(".fpf-conditionbuilder-groups").insertAdjacentHTML("beforeend",t.innerHTML),a.wrapper.setAttribute("data-max-index",d.groupKey)):(i.closest(".item-group-footer")?i.closest(".fpf-conditionbuilder-group").querySelector(".fpf-conditionbuilder-items").insertAdjacentHTML("beforeend",t.innerHTML):i.insertAdjacentHTML("afterend",t.innerHTML),i.closest(".fpf-conditionbuilder-group").setAttribute("data-max-index",n)),o&&o()})},t.addingNewGroup=function(e){return!!e&&!e.closest(".fpf-conditionbuilder-group")},t.call=function(e,t,i){var n=new FormData;n.append("nonce",fpf_js_object.nonce),n.append("action","fpf_conditionbuilder_"+e),n.append("data",JSON.stringify(t)),fetch(fpf_js_object.ajax_url,{method:"POST",body:n}).then(function(e){return e.text()}).then(function(e){i(e),new FPF_Conditionize}).catch(function(e){alert(e)})},e}(),FPF_Condition_Builder_Loader=function(){function e(){this.init()}return e.prototype.init=function(){var t;window.IntersectionObserver&&(t=new IntersectionObserver(function(e,t){e.forEach(function(e){e.isIntersecting&&(new FPF_Condition_Builder(e.target),t.unobserve(e.target))})},{rootMargin:"0px 0px 0px 0px"}),document.querySelectorAll("div.fpf-conditionbuilder").forEach(function(e){t.observe(e)}))},e}();!function(){"use strict";document.addEventListener("DOMContentLoaded",function(){new FPF_Condition_Builder_Loader})}(window);

